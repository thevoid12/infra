# global secure headers
# user  nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
  worker_connections 1024;
  multi_accept on;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  server_tokens off; # hide nginx version
  client_max_body_size 50M;

  # Strong SSL ciphers + TLS config (recommended)
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  # Recommended DH params (generate once and mount)
  ssl_dhparam /etc/ssl/certs/dhparam.pem;

  # Security headers
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;
  add_header X-XSS-Protection "1; mode=block";
  add_header Referrer-Policy "no-referrer-when-downgrade";

  # Basic rate limiting to mitigate simple DOS
  limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;

  # Proxy settings common to upstreams
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_read_timeout 90;
  proxy_connect_timeout 10;
  proxy_send_timeout 10;

  include /etc/nginx/conf.d/*.conf;
}
